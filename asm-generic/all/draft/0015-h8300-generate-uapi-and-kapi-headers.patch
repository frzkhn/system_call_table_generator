From 711a3bacb55de244687121240e033e9cf46b1ba3 Mon Sep 17 00:00:00 2001
From: Firoz Khan <firoz.khan@linaro.org>
Date: Tue, 19 Feb 2019 15:59:52 +0530
Subject: [PATCH 15/27] h8300: generate uapi and kapi headers

Unified system call table generation script need to be invoked
to generated the uapi and kapi headers. The Makefile changes
present in this patch will invoke the scripts and generate uapi
and kapi header files.

The generated files - unistd_*.h and syscall_table_*.h files
will be included by unistd.h and sys_c6x.c files by replacing
asm-generic/unistd.h file.

Signed-off-by: Firoz Khan <firoz.khan@linaro.org>
---
 arch/h8300/Makefile                  |  3 +++
 arch/h8300/include/asm/Kbuild        |  1 +
 arch/h8300/include/uapi/asm/Kbuild   |  1 +
 arch/h8300/include/uapi/asm/unistd.h | 10 +++++++++-
 arch/h8300/kernel/syscalls.c         |  2 +-
 5 files changed, 15 insertions(+), 2 deletions(-)

diff --git a/arch/h8300/Makefile b/arch/h8300/Makefile
index 4003ddc..f6835d7 100644
--- a/arch/h8300/Makefile
+++ b/arch/h8300/Makefile
@@ -42,6 +42,9 @@ archmrproper:
 archclean:
 	$(Q)$(MAKE) $(clean)=$(boot)
 
+archheaders:
+	$(Q)$(MAKE) $(build)=arch/h8300/kernel/syscalls all
+
 vmlinux.srec vmlinux.bin zImage uImage.bin: vmlinux
 	$(Q)$(MAKE) $(build)=$(boot) $(boot)/$@
 
diff --git a/arch/h8300/include/asm/Kbuild b/arch/h8300/include/asm/Kbuild
index cd400d3..10d2a8c 100644
--- a/arch/h8300/include/asm/Kbuild
+++ b/arch/h8300/include/asm/Kbuild
@@ -1,3 +1,4 @@
+generated-y += syscall_table.h
 generic-y += asm-offsets.h
 generic-y += barrier.h
 generic-y += bugs.h
diff --git a/arch/h8300/include/uapi/asm/Kbuild b/arch/h8300/include/uapi/asm/Kbuild
index 6c6f630..28823e3 100644
--- a/arch/h8300/include/uapi/asm/Kbuild
+++ b/arch/h8300/include/uapi/asm/Kbuild
@@ -1,5 +1,6 @@
 include include/uapi/asm-generic/Kbuild.asm
 
+generated-y += unistd_32.h
 generic-y += kvm_para.h
 generic-y += shmparam.h
 generic-y += ucontext.h
diff --git a/arch/h8300/include/uapi/asm/unistd.h b/arch/h8300/include/uapi/asm/unistd.h
index 6281958..a07bb10 100644
--- a/arch/h8300/include/uapi/asm/unistd.h
+++ b/arch/h8300/include/uapi/asm/unistd.h
@@ -3,4 +3,12 @@
 #define __ARCH_WANT_RENAMEAT
 #define __ARCH_WANT_STAT64
 
-#include <asm-generic/unistd.h>
+#include <asm/bitsperlong.h>
+
+#ifndef __SYSCALL
+#define __SYSCALL(x, y)
+#endif
+
+#if __BITS_PER_LONG == 32
+#include <asm/unistd_32.h>
+#endif
diff --git a/arch/h8300/kernel/syscalls.c b/arch/h8300/kernel/syscalls.c
index 9022036..5af8218 100644
--- a/arch/h8300/kernel/syscalls.c
+++ b/arch/h8300/kernel/syscalls.c
@@ -11,5 +11,5 @@
 asmlinkage int sys_rt_sigreturn(void);
 
 void *_sys_call_table[__NR_syscalls] = {
-#include <asm/unistd.h>
+#include <asm/syscall_table.h>
 };
-- 
1.9.1

