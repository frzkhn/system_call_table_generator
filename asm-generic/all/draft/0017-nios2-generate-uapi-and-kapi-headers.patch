From f7229c5757ced16f7ca4a90bdf3f1043821a1d9f Mon Sep 17 00:00:00 2001
From: Firoz Khan <firoz.khan@linaro.org>
Date: Tue, 19 Feb 2019 16:56:31 +0530
Subject: [PATCH 17/27] nios2: generate uapi and kapi headers

Unified system call table generation script need to be invoked
to generated the uapi and kapi headers. The Makefile changes
present in this patch will invoke the scripts and generate uapi
and kapi header files.

The generated files - unistd_*.h and syscall_table_*.h files
will be included by unistd.h and sys_c6x.c files by replacing
asm-generic/unistd.h file.

Signed-off-by: Firoz Khan <firoz.khan@linaro.org>
---
 arch/nios2/Makefile                  |  3 +++
 arch/nios2/include/asm/Kbuild        |  1 +
 arch/nios2/include/uapi/asm/Kbuild   |  1 +
 arch/nios2/include/uapi/asm/unistd.h | 14 +++++++++-----
 arch/nios2/kernel/syscall_table.c    |  3 ++-
 5 files changed, 16 insertions(+), 6 deletions(-)

diff --git a/arch/nios2/Makefile b/arch/nios2/Makefile
index 52c03e6..743522d 100644
--- a/arch/nios2/Makefile
+++ b/arch/nios2/Makefile
@@ -56,6 +56,9 @@ all: vmImage
 archclean:
 	$(Q)$(MAKE) $(clean)=$(nios2-boot)
 
+archheaders:
+	$(Q)$(MAKE) $(build)=arch/nios2/kernel/syscalls all
+
 $(BOOT_TARGETS): vmlinux
 	$(Q)$(MAKE) $(build)=$(nios2-boot) $(nios2-boot)/$@
 
diff --git a/arch/nios2/include/asm/Kbuild b/arch/nios2/include/asm/Kbuild
index 8fde4fa..a8d9ae2 100644
--- a/arch/nios2/include/asm/Kbuild
+++ b/arch/nios2/include/asm/Kbuild
@@ -1,3 +1,4 @@
+generated-y += syscall_table.h
 generic-y += atomic.h
 generic-y += barrier.h
 generic-y += bitops.h
diff --git a/arch/nios2/include/uapi/asm/Kbuild b/arch/nios2/include/uapi/asm/Kbuild
index 0febf1a..97823ec 100644
--- a/arch/nios2/include/uapi/asm/Kbuild
+++ b/arch/nios2/include/uapi/asm/Kbuild
@@ -1,4 +1,5 @@
 include include/uapi/asm-generic/Kbuild.asm
 
+generated-y += unistd_32.h
 generic-y += kvm_para.h
 generic-y += ucontext.h
diff --git a/arch/nios2/include/uapi/asm/unistd.h b/arch/nios2/include/uapi/asm/unistd.h
index d9948d8..03aa9c6 100644
--- a/arch/nios2/include/uapi/asm/unistd.h
+++ b/arch/nios2/include/uapi/asm/unistd.h
@@ -21,9 +21,13 @@
 #define __ARCH_WANT_RENAMEAT
 #define __ARCH_WANT_STAT64
 
-/* Use the standard ABI for syscalls */
-#include <asm-generic/unistd.h>
+#include <asm/bitsperlong.h>
 
-/* Additional Nios II specific syscalls. */
-#define __NR_cacheflush (__NR_arch_specific_syscall)
-__SYSCALL(__NR_cacheflush, sys_cacheflush)
+#ifndef __SYSCALL
+#define __SYSCALL(x, y)
+#endif
+
+#if __BITS_PER_LONG == 32
+#define __NR_cacheflush	__NR_arch_specific_syscall
+#include <asm/unistd_32.h>
+#endif
diff --git a/arch/nios2/kernel/syscall_table.c b/arch/nios2/kernel/syscall_table.c
index 06e6ac1..99c6463 100644
--- a/arch/nios2/kernel/syscall_table.c
+++ b/arch/nios2/kernel/syscall_table.c
@@ -25,5 +25,6 @@
 #define __SYSCALL(nr, call) [nr] = (call),
 
 void *sys_call_table[__NR_syscalls] = {
-#include <asm/unistd.h>
+#define sys_arch_specific_syscall	sys_cacheflush
+#include <asm/syscall_table.h>
 };
-- 
1.9.1

