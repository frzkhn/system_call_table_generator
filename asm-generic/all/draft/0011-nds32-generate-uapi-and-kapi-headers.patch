From 383e773da216efa1ad56b459ad4b6512d232b02f Mon Sep 17 00:00:00 2001
From: Firoz Khan <firoz.khan@linaro.org>
Date: Tue, 19 Feb 2019 12:30:21 +0530
Subject: [PATCH 11/27] nds32: generate uapi and kapi headers

Unified system call table generation script need to be invoked
to generated the uapi and kapi headers. The Makefile changes
present in this patch will invoke the scripts and generate uapi
and kapi header files.

The generated files - unistd_*.h and syscall_table_*.h files
will be included by unistd.h and sys_c6x.c files by replacing
asm-generic/unistd.h file.

Signed-off-by: Firoz Khan <firoz.khan@linaro.org>
---
 arch/nds32/Makefile                  |  3 +++
 arch/nds32/include/asm/Kbuild        |  1 +
 arch/nds32/include/asm/unistd.h      |  4 ++++
 arch/nds32/include/uapi/asm/Kbuild   |  1 +
 arch/nds32/include/uapi/asm/unistd.h | 14 ++++++--------
 arch/nds32/kernel/syscall_table.c    |  4 +++-
 6 files changed, 18 insertions(+), 9 deletions(-)

diff --git a/arch/nds32/Makefile b/arch/nds32/Makefile
index 0a935c1..681185c 100644
--- a/arch/nds32/Makefile
+++ b/arch/nds32/Makefile
@@ -74,6 +74,9 @@ CLEAN_FILES += include/asm-nds32/constants.h*
 archclean:
 	$(Q)$(MAKE) $(clean)=$(boot)
 
+archheaders:
+	$(Q)$(MAKE) $(build)=arch/nds32/kernel/syscalls all
+
 define archhelp
   echo  '  Image         - kernel image (arch/$(ARCH)/boot/Image)'
 endef
diff --git a/arch/nds32/include/asm/Kbuild b/arch/nds32/include/asm/Kbuild
index 64ceff7..6582d88 100644
--- a/arch/nds32/include/asm/Kbuild
+++ b/arch/nds32/include/asm/Kbuild
@@ -1,3 +1,4 @@
+generated-y += syscall_table.h
 generic-y += asm-offsets.h
 generic-y += atomic.h
 generic-y += bitops.h
diff --git a/arch/nds32/include/asm/unistd.h b/arch/nds32/include/asm/unistd.h
index b586a28..af12594 100644
--- a/arch/nds32/include/asm/unistd.h
+++ b/arch/nds32/include/asm/unistd.h
@@ -4,3 +4,7 @@
 #define __ARCH_WANT_SYS_CLONE
 
 #include <uapi/asm/unistd.h>
+
+#ifndef __SYSCALL
+#define __SYSCALL(x, y)
+#endif
diff --git a/arch/nds32/include/uapi/asm/Kbuild b/arch/nds32/include/uapi/asm/Kbuild
index c1b06dc..3f03cf6 100644
--- a/arch/nds32/include/uapi/asm/Kbuild
+++ b/arch/nds32/include/uapi/asm/Kbuild
@@ -1,3 +1,4 @@
 include include/uapi/asm-generic/Kbuild.asm
 
+generated-y += unistd_32.h
 generic-y += ucontext.h
diff --git a/arch/nds32/include/uapi/asm/unistd.h b/arch/nds32/include/uapi/asm/unistd.h
index 65946e5..698acaf 100644
--- a/arch/nds32/include/uapi/asm/unistd.h
+++ b/arch/nds32/include/uapi/asm/unistd.h
@@ -4,13 +4,11 @@
 #define __ARCH_WANT_STAT64
 #define __ARCH_WANT_SYNC_FILE_RANGE2
 
-/* Use the standard ABI for syscalls */
-#include <asm-generic/unistd.h>
+#include <asm/bitsperlong.h>
 
+#if __BITS_PER_LONG == 32
 #define __NR_sync_file_range2	__NR_sync_file_range
-
-/* Additional NDS32 specific syscalls. */
-#define __NR_cacheflush		(__NR_arch_specific_syscall)
-#define __NR_udftrap		(__NR_arch_specific_syscall + 1)
-__SYSCALL(__NR_cacheflush, sys_cacheflush)
-__SYSCALL(__NR_udftrap, sys_udftrap)
+#define __NR_cacheflush		__NR_arch_specific_syscall
+#define __NR_udftrap		__NR_arch_specific_syscall1
+#include <asm/unistd_32.h>
+#endif
diff --git a/arch/nds32/kernel/syscall_table.c b/arch/nds32/kernel/syscall_table.c
index 0d58bbb..0f1759a 100644
--- a/arch/nds32/kernel/syscall_table.c
+++ b/arch/nds32/kernel/syscall_table.c
@@ -14,5 +14,7 @@
 #define sys_fadvise64_64	sys_fadvise64_64_wrapper
 void *sys_call_table[__NR_syscalls] __aligned(8192) = {
 	[0 ... __NR_syscalls - 1] = sys_ni_syscall,
-#include <asm/unistd.h>
+#define sys_arch_specific_syscall	sys_cacheflush
+#define sys_arch_specific_syscall1	sys_udftrap
+#include <asm/syscall_table.h>
 };
-- 
1.9.1

